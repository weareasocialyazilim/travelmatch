# Run lint-staged for code quality checks with optimized memory
# Use --concurrent false to prevent parallel ESLint runs that cause SIGKILL
# Reduced memory to 4GB to avoid OS killing the process
export NODE_OPTIONS="--max-old-space-size=4096"

# Only run lint-staged on staged files
npx lint-staged --concurrent false --no-stash 2>&1 || {
  echo "‚ö†Ô∏è  lint-staged failed - checking if it's a memory issue..."
  echo "   Try running: git add -A && pnpm lint-staged"
  exit 1
}

# Skip type checking in pre-commit for faster commits (run in CI instead)
# pnpm turbo run type-check --filter="[HEAD^1]"

# Check for console.log in production code (excluding tests, stories, mocks, and supabase edge functions)
# Note: Supabase Edge Functions use Deno, where console.log goes to Supabase Logs (acceptable)
echo "üîç Checking for console.log usage..."
FILES_TO_CHECK=$(git diff --cached --name-only | grep -E '\.(ts|tsx)$' | grep -v -E '(\.stories\.|\.test\.|\.spec\.|__tests__|testUtils|supabase/functions)' || true)
if [ -n "$FILES_TO_CHECK" ]; then
  if echo "$FILES_TO_CHECK" | xargs grep -l 'console\.' 2>/dev/null; then
    echo "‚ùå ERROR: console.log found in production code!"
    echo "   Please use logger.debug(), logger.info(), logger.warn(), or logger.error() instead."
    echo "   Import from: import { logger } from '@/utils/logger';"
    exit 1
  fi
fi
echo "‚úÖ No console.log found in production code"
