name: ðŸš€ Deploy Supabase Infrastructure

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'supabase/config.toml'
      - '.github/workflows/deploy-supabase.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
      deploy_migrations:
        description: 'Deploy database migrations'
        required: true
        type: boolean
        default: true
      deploy_functions:
        description: 'Deploy edge functions'
        required: true
        type: boolean
        default: true

env:
  SUPABASE_PROJECT_ID: bjikxgtbptrvawkguypv

jobs:
  deploy:
    name: Deploy to Supabase
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ” Import secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          method: universal
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          domain: 'https://eu.infisical.com'
          project-slug: lovendo-app-infisical2
          env-slug: ${{ github.ref_name == 'main' && 'prod' || 'staging' }}

      - name: ðŸ“¦ Install Supabase CLI
        run: |
          npm install -g supabase@latest
          supabase --version

      - name: ðŸ” Authenticate to Supabase
        run: |
          echo "Authenticating with Supabase..."
          supabase login --token $SUPABASE_ACCESS_TOKEN

      - name: ðŸ”— Link to Supabase project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_ID }} --password $SUPABASE_DB_PASSWORD

      - name: ðŸ—„ï¸ Deploy database migrations
        if: ${{ github.event.inputs.deploy_migrations != 'false' }}
        run: |
          echo "Deploying migrations..."
          supabase db push --linked
          echo "âœ… Migrations deployed successfully"

      - name: âš¡ Deploy Edge Functions
        if: ${{ github.event.inputs.deploy_functions != 'false' }}
        run: |
          echo "Setting Edge Function secrets from Infisical..."
          # Secrets are already imported from Infisical in previous step
          supabase secrets set \
            STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" \
            STRIPE_WEBHOOK_SECRET="$STRIPE_WEBHOOK_SECRET" \
            OPENAI_API_KEY="$OPENAI_API_KEY" \
            CLOUDFLARE_STREAM_API_KEY="$CLOUDFLARE_STREAM_API_KEY" \
            CLOUDFLARE_STREAM_ACCOUNT_ID="$CLOUDFLARE_STREAM_ACCOUNT_ID" \
            MAPBOX_SECRET_TOKEN="$MAPBOX_SECRET_TOKEN"

          echo "Deploying all Edge Functions..."
          supabase functions deploy
          echo "âœ… Edge Functions deployed successfully"

      - name: ðŸ” Verify deployment
        run: |
          echo "Listing applied migrations..."
          supabase migration list --linked

          echo "Listing deployed functions..."
          supabase functions list

          echo "âœ… Deployment verification complete"

      - name: ðŸ“Š Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Supabase Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ env.SUPABASE_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Components" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database migrations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Edge Functions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Function secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Supabase Dashboard](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Database Editor](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }}/editor)" >> $GITHUB_STEP_SUMMARY
          echo "- [Edge Functions](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }}/functions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Logs](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }}/logs/explorer)" >> $GITHUB_STEP_SUMMARY
