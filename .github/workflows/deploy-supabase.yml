name: ðŸš€ Deploy Supabase Infrastructure

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'supabase/config.toml'
      - '.github/workflows/deploy-supabase.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
      deploy_migrations:
        description: 'Deploy database migrations'
        required: true
        type: boolean
        default: true
      deploy_functions:
        description: 'Deploy edge functions'
        required: true
        type: boolean
        default: true

env:
  SUPABASE_PROJECT_ID: bjikxgtbptrvawkguypv

jobs:
  deploy:
    name: Deploy to Supabase
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install Supabase CLI
        run: |
          npm install -g supabase@latest
          supabase --version

      - name: ðŸ” Authenticate to Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Authenticating with Supabase..."
          supabase login --token $SUPABASE_ACCESS_TOKEN

      - name: ðŸ”— Link to Supabase project
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_ID }} --password $SUPABASE_DB_PASSWORD

      - name: ðŸ—„ï¸ Deploy database migrations
        if: ${{ github.event.inputs.deploy_migrations != 'false' }}
        run: |
          echo "Deploying migrations..."
          supabase db push --linked
          echo "âœ… Migrations deployed successfully"

      - name: âš¡ Deploy Edge Functions
        if: ${{ github.event.inputs.deploy_functions != 'false' }}
        env:
          # Secrets for Edge Functions
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CLOUDFLARE_STREAM_API_KEY: ${{ secrets.CLOUDFLARE_STREAM_API_KEY }}
          CLOUDFLARE_STREAM_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_STREAM_ACCOUNT_ID }}
          GOOGLE_MAPS_SERVER_KEY: ${{ secrets.GOOGLE_MAPS_SERVER_KEY }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
        run: |
          echo "Setting Edge Function secrets..."
          supabase secrets set \
            STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" \
            STRIPE_WEBHOOK_SECRET="$STRIPE_WEBHOOK_SECRET" \
            OPENAI_API_KEY="$OPENAI_API_KEY" \
            CLOUDFLARE_STREAM_API_KEY="$CLOUDFLARE_STREAM_API_KEY" \
            CLOUDFLARE_STREAM_ACCOUNT_ID="$CLOUDFLARE_STREAM_ACCOUNT_ID" \
            GOOGLE_MAPS_SERVER_KEY="$GOOGLE_MAPS_SERVER_KEY" \
            UPSTASH_REDIS_REST_URL="$UPSTASH_REDIS_REST_URL" \
            UPSTASH_REDIS_REST_TOKEN="$UPSTASH_REDIS_REST_TOKEN"

          echo "Deploying all Edge Functions..."
          supabase functions deploy
          echo "âœ… Edge Functions deployed successfully"

      - name: ðŸ” Verify deployment
        run: |
          echo "Listing applied migrations..."
          supabase migration list --linked

          echo "Listing deployed functions..."
          supabase functions list

          echo "âœ… Deployment verification complete"

      - name: ðŸ“Š Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Supabase Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ env.SUPABASE_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Components" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database migrations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Edge Functions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Function secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Supabase Dashboard](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Database Editor](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }}/editor)" >> $GITHUB_STEP_SUMMARY
          echo "- [Edge Functions](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }}/functions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Logs](https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_ID }}/logs/explorer)" >> $GITHUB_STEP_SUMMARY
