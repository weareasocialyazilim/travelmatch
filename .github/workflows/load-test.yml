name: Load Testing

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL for load testing'
        required: false
        default: 'http://localhost:54321'
      duration:
        description: 'Test duration (e.g., 30s, 1m, 5m)'
        required: false
        default: '30s'
      vus:
        description: 'Number of virtual users'
        required: false
        default: '10'
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'

jobs:
  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for k6 test files
        id: check-k6
        run: |
          if [ -d "tests/load" ] && ls tests/load/*.js 1> /dev/null 2>&1; then
            echo "k6_tests=true" >> $GITHUB_OUTPUT
          else
            echo "k6_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Install k6
        if: steps.check-k6.outputs.k6_tests == 'true'
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 load tests
        if: steps.check-k6.outputs.k6_tests == 'true'
        run: |
          echo "Running k6 load tests..."
          for test in tests/load/*.js; do
            echo "Running $test..."
            k6 run "$test" --duration=${{ github.event.inputs.duration || '30s' }} --vus=${{ github.event.inputs.vus || '10' }} || true
          done

      - name: Basic API smoke test (fallback)
        if: steps.check-k6.outputs.k6_tests != 'true'
        run: |
          echo "No k6 test files found. Running basic smoke test..."
          echo "## Load Test Report" > load-test-report.md
          echo "Date: $(date)" >> load-test-report.md
          echo "" >> load-test-report.md
          echo "### Note" >> load-test-report.md
          echo "No k6 test files found in tests/load/" >> load-test-report.md
          echo "" >> load-test-report.md
          echo "To enable load testing, create k6 test files in the tests/load/ directory." >> load-test-report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-report
          path: load-test-report.md
          retention-days: 30
          if-no-files-found: ignore
