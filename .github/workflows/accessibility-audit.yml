name: Accessibility Audit

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'apps/admin/**'
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'apps/admin/**'
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.22.0'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: |
          cd apps/web && pnpm run build || echo "Web build failed, skipping"
        env:
          NODE_ENV: production
        continue-on-error: true

      - name: Install pa11y
        run: npm install -g pa11y pa11y-ci

      - name: Run basic accessibility check
        run: |
          echo "Running accessibility checks..."

          # Check if web build exists
          if [ -d "apps/web/.next" ] || [ -d "apps/web/dist" ]; then
            echo "✅ Web build found, running pa11y..."
            # Start preview server and run pa11y
            cd apps/web
            pnpm run preview &
            sleep 10
            pa11y http://localhost:3000 --reporter cli --threshold 10 || true
            kill %1 || true
          else
            echo "⚠️ No web build found, skipping live accessibility tests"
          fi

      - name: Generate accessibility report
        run: |
          echo "## Accessibility Audit Report" > accessibility-report.md
          echo "Date: $(date)" >> accessibility-report.md
          echo "" >> accessibility-report.md
          echo "### Summary" >> accessibility-report.md
          echo "- Automated accessibility scan completed" >> accessibility-report.md
          echo "- Manual testing recommended before production release" >> accessibility-report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report
          path: accessibility-report.md
          retention-days: 30
