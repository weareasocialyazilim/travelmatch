name: E2E Tests (Detox - Critical Flows)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/e2e/**'
      - 'package.json'
      - '.github/workflows/e2e-detox.yml'
  push:
    branches: [main]
  schedule:
    # Run nightly at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

concurrency:
  group: e2e-detox-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-detox-ios:
    name: Detox E2E Tests (iOS - Critical Flows)
    runs-on: macos-13
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        flow: [payment, proof-verification, chat, offline]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Setup Ruby for CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          
      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
          
      - name: Install Detox CLI
        run: npm install -g detox-cli
        
      - name: Build iOS app for testing
        run: |
          detox build --configuration ios.sim.release
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          STRIPE_TEST_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}
          
      - name: Run ${{ matrix.flow }} E2E tests
        run: |
          detox test \
            tests/e2e/${{ matrix.flow }}Flow.e2e.test.ts \
            --configuration ios.sim.release \
            --cleanup \
            --record-videos failing \
            --take-screenshots failing \
            --record-logs failing \
            --loglevel verbose
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_STRIPE_CARD: '4242424242424242'
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detox-results-ios-${{ matrix.flow }}
          path: |
            e2e/artifacts/
            coverage/
          retention-days: 7
          
      - name: Upload failure videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-videos-ios-${{ matrix.flow }}
          path: e2e/artifacts/**/*.mp4
          retention-days: 14
          
      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-screenshots-ios-${{ matrix.flow }}
          path: e2e/artifacts/**/*.png
          retention-days: 14
          
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const flow = '${{ matrix.flow }}';
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';
            
            const comment = `### ${emoji} E2E Test Results (iOS - ${flow})
            
            **Status:** ${status.toUpperCase()}
            **Flow:** ${flow} Flow
            **Platform:** iOS Simulator
            **Duration:** ${{ job.duration }}
            
            ${status === 'failure' ? 'âš ï¸ **Artifacts uploaded for debugging**' : ''}
            
            [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  e2e-detox-android:
    name: Detox E2E Tests (Android - Critical Flows)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        flow: [payment, proof-verification, chat, offline]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install Detox CLI
        run: npm install -g detox-cli
        
      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-33-${{ runner.os }}
          
      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."
          
      - name: Build Android app for testing
        run: |
          detox build --configuration android.emu.release
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          STRIPE_TEST_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}
          
      - name: Run ${{ matrix.flow }} E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            detox test \
              tests/e2e/${{ matrix.flow }}Flow.e2e.test.ts \
              --configuration android.emu.release \
              --cleanup \
              --record-videos failing \
              --take-screenshots failing \
              --record-logs failing \
              --loglevel verbose
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_STRIPE_CARD: '4242424242424242'
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detox-results-android-${{ matrix.flow }}
          path: |
            e2e/artifacts/
            coverage/
          retention-days: 7
          
      - name: Upload failure videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-videos-android-${{ matrix.flow }}
          path: e2e/artifacts/**/*.mp4
          retention-days: 14
          
      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-screenshots-android-${{ matrix.flow }}
          path: e2e/artifacts/**/*.png
          retention-days: 14
          
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const flow = '${{ matrix.flow }}';
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';
            
            const comment = `### ${emoji} E2E Test Results (Android - ${flow})
            
            **Status:** ${status.toUpperCase()}
            **Flow:** ${flow} Flow
            **Platform:** Android Emulator (API 33)
            **Duration:** ${{ job.duration }}
            
            ${status === 'failure' ? 'âš ï¸ **Artifacts uploaded for debugging**' : ''}
            
            [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  e2e-status-check:
    name: E2E Status Check (Required)
    needs: [e2e-detox-ios, e2e-detox-android]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check E2E test results
        run: |
          if [ "${{ needs.e2e-detox-ios.result }}" == "failure" ] || [ "${{ needs.e2e-detox-android.result }}" == "failure" ]; then
            echo "âŒ E2E tests failed"
            exit 1
          elif [ "${{ needs.e2e-detox-ios.result }}" == "cancelled" ] || [ "${{ needs.e2e-detox-android.result }}" == "cancelled" ]; then
            echo "âš ï¸ E2E tests cancelled"
            exit 1
          else
            echo "âœ… All E2E tests passed"
            exit 0
          fi
          
      - name: Create status summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.e2e-detox-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.e2e-detox-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Flows" >> $GITHUB_STEP_SUMMARY
          echo "- Payment Flow (Gift Sending)" >> $GITHUB_STEP_SUMMARY
          echo "- Proof Verification Flow" >> $GITHUB_STEP_SUMMARY
          echo "- Chat/Messaging Flow" >> $GITHUB_STEP_SUMMARY
          echo "- Offline Scenarios" >> $GITHUB_STEP_SUMMARY
          
  notify-slack:
    name: Notify Slack
    needs: [e2e-status-check]
    runs-on: ubuntu-latest
    if: failure() && (github.event_name == 'push' || github.event_name == 'schedule')
    
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ Critical E2E Tests Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Critical E2E Tests Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Failed Flows:*\nâ€¢ Payment Flow\nâ€¢ Proof Verification\nâ€¢ Chat/Messaging\nâ€¢ Offline Scenarios"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
