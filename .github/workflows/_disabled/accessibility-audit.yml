name: Accessibility Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  axe-audit:
    name: Axe Accessibility Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run Axe accessibility tests
        run: |
          # Start server in background
          pnpm run preview &
          SERVER_PID=$!

          # Wait for server to be ready
          npx wait-on http://localhost:4173

          # Run axe tests
          npx @axe-core/cli http://localhost:4173 \
            --exit \
            --threshold 0 \
            --tags wcag2a,wcag2aa,wcag21a,wcag21aa \
            --disable color-contrast \
            --save axe-results.json

          # Kill server
          kill $SERVER_PID

      - name: Upload Axe results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: axe-results
          path: axe-results.json
          retention-days: 30

      - name: Check accessibility violations
        run: |
          VIOLATIONS=$(jq '.violations | length' axe-results.json)
          echo "Accessibility violations: $VIOLATIONS"

          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå Found $VIOLATIONS accessibility violations"
            jq '.violations[] | {impact, description, nodes: .nodes | length}' axe-results.json
            exit 1
          fi

          echo "‚úÖ No accessibility violations found"

  pa11y-audit:
    name: Pa11y Accessibility Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build

      - name: Run Pa11y tests
        run: |
          npm install -g pa11y-ci

          # Start server
          pnpm run preview &
          SERVER_PID=$!

          # Wait for server
          npx wait-on http://localhost:4173

          # Run Pa11y
          pa11y-ci \
            --config .pa11yci.json \
            --threshold 0

          # Kill server
          kill $SERVER_PID

  lighthouse-accessibility:
    name: Lighthouse Accessibility Score
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build

      - name: Run Lighthouse
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Check accessibility score
        run: |
          A11Y_SCORE=$(cat .lighthouseci/manifest.json | jq '.[0].summary.accessibility')
          echo "Accessibility Score: $(echo "$A11Y_SCORE * 100" | bc)%"

          # Require 95+ score (WCAG 2.1 AA)
          if (( $(echo "$A11Y_SCORE < 0.95" | bc -l) )); then
            echo "‚ùå Accessibility score $A11Y_SCORE is below 0.95 threshold"
            exit 1
          fi

          echo "‚úÖ Accessibility score OK: $A11Y_SCORE"

  contrast-check:
    name: Color Contrast Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g wcag-color-contrast-checker

      - name: Check design token colors
        run: |
          node << 'EOF'
          const { checkContrastRatio } = require('./src/config/accessibility.ts');
          const { colors } = require('./packages/design-system/src/tokens/colors.ts');

          let violations = [];

          // Check primary colors against white background
          Object.entries(colors.primary).forEach(([shade, color]) => {
            const result = checkContrastRatio(color, '#FFFFFF');
            if (!result.passesAA) {
              violations.push(`Primary ${shade} (${color}) on white: ${result.ratio}:1 (needs 4.5:1)`);
            }
          });

          // Check text colors
          Object.entries(colors.text).forEach(([type, color]) => {
            const result = checkContrastRatio(color, colors.background.primary);
            if (!result.passesAA) {
              violations.push(`Text ${type} (${color}): ${result.ratio}:1 (needs 4.5:1)`);
            }
          });

          if (violations.length > 0) {
            console.error('‚ùå Color contrast violations:');
            violations.forEach(v => console.error('  -', v));
            process.exit(1);
          }

          console.log('‚úÖ All color contrasts pass WCAG AA');
          EOF

  keyboard-navigation:
    name: Keyboard Navigation Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run keyboard navigation tests
        run: |
          npx playwright test tests/accessibility/keyboard-nav.spec.ts

  screen-reader-test:
    name: Screen Reader Compatibility
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check ARIA labels
        run: |
          # Check for proper ARIA usage
          grep -r "aria-label\|aria-labelledby\|aria-describedby\|role=" src/components/ || echo "No ARIA attributes found"

          # Validate ARIA roles
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const validRoles = [
            'button', 'link', 'navigation', 'main', 'search', 'form',
            'article', 'complementary', 'banner', 'contentinfo', 'region'
          ];

          function checkFiles(dir) {
            const files = fs.readdirSync(dir);
            let violations = [];
            
            files.forEach(file => {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              
              if (stat.isDirectory()) {
                violations = violations.concat(checkFiles(filePath));
              } else if (file.endsWith('.tsx') || file.endsWith('.jsx')) {
                const content = fs.readFileSync(filePath, 'utf8');
                const roleMatches = content.match(/role=["']([^"']+)["']/g) || [];
                
                roleMatches.forEach(match => {
                  const role = match.match(/role=["']([^"']+)["']/)[1];
                  if (!validRoles.includes(role)) {
                    violations.push(`${filePath}: Invalid ARIA role "${role}"`);
                  }
                });
              }
            });
            
            return violations;
          }

          const violations = checkFiles('src/components');

          if (violations.length > 0) {
            console.error('‚ùå ARIA violations:');
            violations.forEach(v => console.error('  -', v));
            process.exit(1);
          }

          console.log('‚úÖ All ARIA roles valid');
          EOF

  accessibility-report:
    name: Generate Accessibility Report
    runs-on: ubuntu-latest
    needs:
      [
        axe-audit,
        pa11y-audit,
        lighthouse-accessibility,
        contrast-check,
        keyboard-navigation,
      ]
    if: always()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Generate report
        run: |
          echo "# üéØ Accessibility Report" > report.md
          echo "" >> report.md
          echo "**Date:** $(date)" >> report.md
          echo "**Standard:** WCAG 2.1 Level AA" >> report.md
          echo "" >> report.md

          # Add Lighthouse accessibility score
          if [ -f lighthouse-reports/manifest.json ]; then
            A11Y_SCORE=$(cat lighthouse-reports/manifest.json | jq '.[0].summary.accessibility')
            echo "## Lighthouse Score" >> report.md
            echo "- Accessibility: $(echo "$A11Y_SCORE * 100" | bc)% (target: 95%)" >> report.md
            echo "" >> report.md
          fi

          # Add Axe violations
          if [ -f axe-results/axe-results.json ]; then
            VIOLATIONS=$(jq '.violations | length' axe-results/axe-results.json)
            echo "## Axe Violations" >> report.md
            echo "- Total: $VIOLATIONS" >> report.md
            
            if [ $VIOLATIONS -gt 0 ]; then
              echo "" >> report.md
              echo "### Issues Found:" >> report.md
              jq -r '.violations[] | "- **\(.impact)**: \(.description) (\(.nodes | length) instance(s))"' axe-results/axe-results.json >> report.md
            fi
            echo "" >> report.md
          fi

          cat report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
