name: 'Device Farm Tests'

on:
  # Run on PR
  pull_request:
    types: [opened, synchronize, reopened]
  
  # Run on main branch push
  push:
    branches: [main]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - performance
          - compatibility
      
      platform:
        description: 'Platform'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both

jobs:
  # Build Android APK
  build-android:
    if: inputs.platform == 'android' || inputs.platform == 'both' || github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      
      - name: Build Android APK
        working-directory: apps/mobile/android
        run: ./gradlew assembleRelease
      
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: android-apk
          path: apps/mobile/android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30
  
  # Build iOS IPA
  build-ios:
    if: inputs.platform == 'ios' || inputs.platform == 'both' || github.event_name != 'workflow_dispatch'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '14.3'
      
      - name: Install pods
        working-directory: apps/mobile/ios
        run: pod install
      
      - name: Build iOS IPA
        working-directory: apps/mobile/ios
        run: |
          xcodebuild -workspace travelmatchnew.xcworkspace \
            -scheme travelmatchnew \
            -configuration Release \
            -archivePath build/app.xcarchive \
            archive
          
          xcodebuild -exportArchive \
            -archivePath build/app.xcarchive \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist
      
      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: ios-ipa
          path: apps/mobile/ios/build/TravelMatch.ipa
          retention-days: 30
  
  # AWS Device Farm - Android
  test-android-devicefarm:
    needs: build-android
    if: inputs.platform == 'android' || inputs.platform == 'both' || github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download APK
        uses: actions/download-artifact@v3
        with:
          name: android-apk
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      
      - name: Run Device Farm Tests
        uses: aws-actions/aws-devicefarm-run-test@v1
        with:
          project-arn: ${{ secrets.AWS_DEVICE_FARM_PROJECT_ARN }}
          app-path: app-release.apk
          app-type: ANDROID_APP
          test-type: APPIUM_NODE
          test-package-path: tests/e2e
          test-spec-path: .device-farm.yml
          device-pool-arn: ${{ secrets.AWS_DEVICE_FARM_DEVICE_POOL_ARN }}
          name: 'Android ${{ inputs.suite || github.event_name }}'
      
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: android-devicefarm-results
          path: devicefarm-results/
  
  # AWS Device Farm - iOS
  test-ios-devicefarm:
    needs: build-ios
    if: inputs.platform == 'ios' || inputs.platform == 'both' || github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download IPA
        uses: actions/download-artifact@v3
        with:
          name: ios-ipa
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      
      - name: Run Device Farm Tests
        uses: aws-actions/aws-devicefarm-run-test@v1
        with:
          project-arn: ${{ secrets.AWS_DEVICE_FARM_PROJECT_ARN }}
          app-path: TravelMatch.ipa
          app-type: IOS_APP
          test-type: APPIUM_NODE
          test-package-path: tests/e2e
          test-spec-path: .device-farm.yml
          device-pool-arn: ${{ secrets.AWS_DEVICE_FARM_IOS_DEVICE_POOL_ARN }}
          name: 'iOS ${{ inputs.suite || github.event_name }}'
      
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ios-devicefarm-results
          path: devicefarm-results/
  
  # BrowserStack - Parallel Testing
  test-browserstack:
    needs: [build-android, build-ios]
    if: github.event.inputs.suite == 'regression' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Android devices
          - platform: android
            device: 'Samsung Galaxy S23'
            os: '13.0'
          - platform: android
            device: 'Google Pixel 7'
            os: '13.0'
          
          # iOS devices
          - platform: ios
            device: 'iPhone 14 Pro'
            os: '16'
          - platform: ios
            device: 'iPhone 13'
            os: '16'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Download APK/IPA
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.platform == 'android' && 'android-apk' || 'ios-ipa' }}
      
      - name: Upload to BrowserStack
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@${{ matrix.platform == 'android' && 'app-release.apk' || 'TravelMatch.ipa' }}" \
            -o app-upload.json
          
          echo "APP_URL=$(jq -r '.app_url' app-upload.json)" >> $GITHUB_ENV
      
      - name: Run Tests on BrowserStack
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          pnpm test:e2e:browserstack \
            --platform=${{ matrix.platform }} \
            --device="${{ matrix.device }}" \
            --os="${{ matrix.os }}" \
            --app=${{ env.APP_URL }}
      
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: browserstack-results-${{ matrix.platform }}-${{ matrix.device }}
          path: test-results/
  
  # Generate Test Report
  report:
    needs: [test-android-devicefarm, test-ios-devicefarm, test-browserstack]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all results
        uses: actions/download-artifact@v3
      
      - name: Generate Combined Report
        run: |
          node scripts/generate-device-farm-report.mjs
      
      - name: Upload Combined Report
        uses: actions/upload-artifact@v3
        with:
          name: combined-test-report
          path: test-reports/
      
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test-reports/summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
      
      - name: Fail if tests failed
        run: |
          if [ -f "test-reports/failed.txt" ]; then
            echo "❌ Tests failed!"
            exit 1
          fi
          echo "✅ All tests passed!"
