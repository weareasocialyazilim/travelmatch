name: Production Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - beta
          - production

env:
  NODE_VERSION: '20'

jobs:
  pre-deploy-checks:
    name: Pre-Deploy Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Import secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          workspaceId: fa0ed450-40e2-4063-b4f4-ce5cca83a57e
          env-slug: prod

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm run lint

      - name: Run type check
        run: pnpm run type-check
        continue-on-error: true

      - name: Run tests
        run: pnpm test -- --ci --passWithNoTests
        continue-on-error: true

      - name: Security audit
        run: pnpm audit --audit-level=critical
        continue-on-error: true

  build-ios:
    name: Build iOS Production
    needs: pre-deploy-checks
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Import secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          workspaceId: fa0ed450-40e2-4063-b4f4-ce5cca83a57e
          env-slug: prod

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build iOS
        run: |
          cd apps/mobile
          eas build --platform ios --profile production --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          SENTRY_AUTH_TOKEN: ${{ env.SENTRY_AUTH_TOKEN }}

  build-android:
    name: Build Android Production
    needs: pre-deploy-checks
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Import secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          workspaceId: fa0ed450-40e2-4063-b4f4-ce5cca83a57e
          env-slug: prod

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android
        run: |
          cd apps/mobile
          eas build --platform android --profile production --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          SENTRY_AUTH_TOKEN: ${{ env.SENTRY_AUTH_TOKEN }}

  submit-ios:
    name: Submit to App Store
    needs: build-ios
    if: github.event.inputs.track == 'production' || github.event.inputs.track == 'beta'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Import secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          workspaceId: fa0ed450-40e2-4063-b4f4-ce5cca83a57e
          env-slug: prod

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to App Store
        run: |
          cd apps/mobile
          eas submit --platform ios --latest --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  submit-android:
    name: Submit to Play Store
    needs: build-android
    if: github.event.inputs.track == 'production' || github.event.inputs.track == 'beta'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Import secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          workspaceId: fa0ed450-40e2-4063-b4f4-ce5cca83a57e
          env-slug: prod

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to Play Store
        run: |
          cd apps/mobile
          eas submit --platform android --latest --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  notify-success:
    name: Notify Deployment Success
    needs: [submit-ios, submit-android]
    if: always() && (needs.submit-ios.result == 'success' || needs.submit-android.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: ${{ needs.submit-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android**: ${{ needs.submit-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
