# Type Generation & Drift Detection Workflow
# Ensures database types stay in sync with Supabase schema
name: Type Safety

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - 'apps/mobile/src/types/database.types.ts'
      - 'apps/mobile/src/types/db.ts'
  pull_request:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - 'apps/mobile/src/types/**'
  # Allow manual trigger
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  check-type-drift:
    name: Check Type Drift
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: Generate fresh types from remote
        if: env.SUPABASE_ACCESS_TOKEN != ''
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_ID }}
          supabase gen types typescript --linked > apps/mobile/src/types/database.generated.ts
          
      - name: Check for type drift
        id: drift-check
        run: |
          if [ -f apps/mobile/src/types/database.generated.ts ]; then
            if ! diff -q apps/mobile/src/types/database.types.ts apps/mobile/src/types/database.generated.ts > /dev/null 2>&1; then
              echo "drift=true" >> $GITHUB_OUTPUT
              echo "::warning::Database types are out of sync with schema!"
              echo "Run 'pnpm db:types' to regenerate types."
              diff apps/mobile/src/types/database.types.ts apps/mobile/src/types/database.generated.ts || true
            else
              echo "drift=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Types are in sync"
            fi
          else
            echo "drift=skip" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping drift check (no Supabase access token)"
          fi
          
      - name: Run TypeScript type check
        run: pnpm --filter @travelmatch/mobile type-check
        
      - name: Validate db.ts exports
        run: |
          cd apps/mobile
          # Check that db.ts compiles without errors
          npx tsc --noEmit src/types/db.ts --skipLibCheck
          echo "‚úÖ db.ts exports are valid"
          
      - name: Comment on PR (if drift detected)
        if: github.event_name == 'pull_request' && steps.drift-check.outputs.drift == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ö†Ô∏è **Type Drift Detected**
              
              The database types in \`database.types.ts\` are out of sync with the current schema.
              
              **Action Required:**
              \`\`\`bash
              pnpm db:types
              \`\`\`
              
              Then commit the updated types.`
            })

  migration-safety:
    name: Migration Safety Check
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'migration') || contains(github.event.pull_request.title, 'migration')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check migration idempotency
        run: |
          echo "üîç Checking migrations for idempotency patterns..."
          
          # Find all SQL migrations
          for file in supabase/migrations/*.sql; do
            echo "Checking $file..."
            
            # Check for CREATE TABLE without IF NOT EXISTS
            if grep -E "CREATE TABLE(?! IF NOT EXISTS)" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  Warning: $file has CREATE TABLE without IF NOT EXISTS"
            fi
            
            # Check for CREATE FUNCTION without OR REPLACE
            if grep -E "CREATE FUNCTION(?! OR REPLACE)" "$file" > /dev/null 2>&1; then
              # Exclude those that use IF NOT EXISTS pattern
              if ! grep -E "CREATE OR REPLACE FUNCTION" "$file" > /dev/null 2>&1; then
                echo "‚ö†Ô∏è  Warning: $file has CREATE FUNCTION without OR REPLACE"
              fi
            fi
            
            # Check for DROP statements without IF EXISTS
            if grep -E "DROP (TABLE|FUNCTION|INDEX|TRIGGER)(?! IF EXISTS)" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  Warning: $file has DROP without IF EXISTS"
            fi
          done
          
          echo "‚úÖ Migration safety check complete"
          
      - name: Verify RLS enabled on new tables
        run: |
          echo "üõ°Ô∏è Checking RLS enforcement..."
          
          for file in supabase/migrations/*.sql; do
            # Find tables created in this migration
            tables=$(grep -oE "CREATE TABLE (IF NOT EXISTS )?[a-z_]+" "$file" | awk '{print $NF}')
            
            for table in $tables; do
              # Check if RLS is enabled for this table in the same file
              if ! grep -E "ALTER TABLE.*$table.*ENABLE ROW LEVEL SECURITY" "$file" > /dev/null 2>&1; then
                echo "‚ö†Ô∏è  Warning: Table '$table' in $file may not have RLS enabled"
              fi
            done
          done
          
          echo "‚úÖ RLS check complete"

  notify-on-failure:
    name: Notify on Failure
    needs: [check-type-drift, migration-safety]
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Slack notification
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author
          mention: 'channel'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
