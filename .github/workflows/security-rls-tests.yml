name: Security - RLS Policy Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/tests/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/tests/**'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  rls-security-tests:
    name: RLS Security Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase local instance
        run: supabase start

      - name: Wait for database to be ready
        run: |
          echo "Waiting for database..."
          sleep 10
          supabase status

      - name: Run RLS policy tests
        id: rls_tests
        run: |
          chmod +x supabase/tests/run_rls_tests.sh
          ./supabase/tests/run_rls_tests.sh local 2>&1 | tee rls_test_output.log
        continue-on-error: true

      - name: Check for security failures
        run: |
          if grep -q "FAIL:" rls_test_output.log; then
            echo "::error::RLS policy tests failed - SECURITY BREACH DETECTED"
            echo "Failed tests:"
            grep "FAIL:" rls_test_output.log
            exit 1
          fi

      - name: Check for test errors
        run: |
          if grep -q "ERROR:" rls_test_output.log; then
            echo "::error::RLS tests encountered errors"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rls-test-results
          path: rls_test_output.log
          retention-days: 30

      - name: Comment on PR (if failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('rls_test_output.log', 'utf8');
            const failures = output.split('\n').filter(line => line.includes('FAIL:'));
            
            const body = `## ðŸš¨ RLS Security Tests Failed
            
            **SECURITY BREACH DETECTED**
            
            The following RLS policy tests failed:
            
            \`\`\`
            ${failures.join('\n')}
            \`\`\`
            
            ### Action Required:
            1. Review the failed policies
            2. Fix the RLS policy definitions
            3. Re-run tests locally: \`npm run db:test:rls\`
            4. Push fixes
            
            **âš ï¸ This PR cannot be merged until all security tests pass.**
            
            See [RLS Testing Guide](../docs/RLS_TESTING_GUIDE.md) for help.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Success summary
        if: success()
        run: |
          echo "::notice::âœ… All RLS security tests passed"
          echo "Security posture verified - no data leak vulnerabilities detected"

      - name: Stop Supabase
        if: always()
        run: supabase stop

  # Advanced security tests
  advanced-security-tests:
    name: Advanced Security Tests
    runs-on: ubuntu-latest
    needs: rls-security-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase local instance
        run: supabase start

      - name: Run advanced security tests
        run: |
          DB_URL=$(supabase status | grep "DB URL" | awk '{print $3}')
          psql "$DB_URL" -f supabase/tests/rls_advanced_security.test.sql 2>&1 | tee advanced_test_output.log

      - name: Check for vulnerabilities
        run: |
          if grep -q "FAIL:" advanced_test_output.log; then
            echo "::error::Advanced security tests failed"
            grep "FAIL:" advanced_test_output.log
            exit 1
          fi

      - name: Upload advanced test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: advanced-security-test-results
          path: advanced_test_output.log
          retention-days: 30

      - name: Stop Supabase
        if: always()
        run: supabase stop

  # Security report
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [rls-security-tests, advanced-security-tests]
    if: always()
    
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4

      - name: Generate security report
        run: |
          echo "# Security Test Report" > security_report.md
          echo "" >> security_report.md
          echo "**Date**: $(date)" >> security_report.md
          echo "**Commit**: ${{ github.sha }}" >> security_report.md
          echo "" >> security_report.md
          
          echo "## RLS Policy Tests" >> security_report.md
          if [ -f rls-test-results/rls_test_output.log ]; then
            PASS_COUNT=$(grep -c "PASS:" rls-test-results/rls_test_output.log || echo "0")
            FAIL_COUNT=$(grep -c "FAIL:" rls-test-results/rls_test_output.log || echo "0")
            echo "- Tests Passed: $PASS_COUNT âœ…" >> security_report.md
            echo "- Tests Failed: $FAIL_COUNT âŒ" >> security_report.md
          fi
          echo "" >> security_report.md
          
          echo "## Advanced Security Tests" >> security_report.md
          if [ -f advanced-security-test-results/advanced_test_output.log ]; then
            ADV_PASS=$(grep -c "PASS:" advanced-security-test-results/advanced_test_output.log || echo "0")
            ADV_FAIL=$(grep -c "FAIL:" advanced-security-test-results/advanced_test_output.log || echo "0")
            echo "- Tests Passed: $ADV_PASS âœ…" >> security_report.md
            echo "- Tests Failed: $ADV_FAIL âŒ" >> security_report.md
          fi
          
          cat security_report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security_report.md
          retention-days: 90
